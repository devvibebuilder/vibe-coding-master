# .cursorrules - Master Repository Constitution (v3.2.0)

## 1. DIRECTORY GOVERNANCE & PROJECT DNA
- **Strict Layer Isolation:**
    - `/logic`: Core business logic and domain entities only. Pure functions, no external dependencies.
    - `/interfaces`: API definitions, DTOs, and abstract contracts. The "What", not the "How".
    - `/adapters`: Implementation details (DB, External APIs, Frameworks). Implementation of interfaces.
    - `/specs`: Technical specifications, documentation, and architectural decisions (ADRs).
    - `/tests`: Unit, integration, and E2E testing suites mirroring the source structure.
    - `/audit`: Security logs, performance reports, and compliance documentation.

## 2. SYSTEMATIC EXECUTION PROTOCOL (INTERNAL CHAIN OF THOUGHT)
Before outputting any code, the agent must perform and document:
1. **Context Mapping:** Analyze `/interfaces` and `/logic` before proposing changes in `/adapters`.
2. **Root Cause Analysis (RCA):** For debugging, trace the error across layers before fixing.
3. **Trade-off Analysis:** Explicitly state architectural decisions (e.g., "Placed in Adapters to keep Logic pure").
4. **Adversarial Review:** Identify potential race conditions, edge cases, and O(n^2) complexity.

## 3. TECHNICAL CONSTRAINTS & TYPE PROHIBITIONS
- **Type Integrity:** Zero tolerance for `any`, `as unknown`, or `!`. Use Discriminated Unions and Type Guards.
- **Boundary Validation:** Use Zod/TypeBox at the `/interfaces` level to validate all incoming data.
- **Error Handling:** Use Result/Either patterns for domain errors. Avoid try/catch for flow control.
- **Complexity Limits:** Functions < 20 lines. Maximum 3 arguments per function.
- **Naming Convention:** Booleans must use prefixes (is, has, should, can). Functions must start with a verb.

## 4. SECURITY & OBSERVABILITY (GOD MODE)
- **Security First:** Sanitize all inputs at the Adapter level. Prevent XSS, SQLi, and CSRF.
- **Zero Secrets:** Hardcoded credentials trigger immediate failure. Use encrypted env vars.
- **Audit Logging:** Critical operations must be logged and documented in the `/audit` directory.
- **Performance:** Ensure O(n) or better. Implement debouncing/throttling for high-frequency operations.

## 5. WORKSPACE & CONTEXT MANAGEMENT
- **Token Efficiency:** Be concise. Do not rewrite existing files unless a refactor is requested.
- **Modularization:** Files > 250 lines must be decomposed into sub-modules within their layer.
- **Context Pinning:** Always prioritize types in `/interfaces` over local definitions.

## 6. DOCUMENTATION & VERSION CONTROL
- **Standards:** TSDoc/JSDoc required for all exported members in `/logic` and `/interfaces`.
- **Git Flow:** All suggestions must follow Conventional Commits (feat, fix, refactor, chore, docs).
- **Tech Debt:** Mark temporary solutions with `// TODO: TECH DEBT [ID]` and document the refactor path.

## 7. AMBIGUITY RESOLUTION PROTOCOL
- If a request lacks technical depth, the agent MUST stop and ask for:
    1. Input/Output Data Schemas.
    2. Expected Side Effects (DB, Network, State).
    3. Performance/Scale requirements.
- **Active Specification Leading:** Si el usuario intenta codificar sin haber completado `specs/plantilla_vision.md`, el agente DEBE:
    1. Notificar que el "Business Case" no está definido.
    2. Actuar como Consultor: Hacer preguntas socráticas para completar las secciones I, II y III de la plantilla.
    3. No proceder a `/logic` hasta que la sección "II. TRADUCCIÓN A ESPECIFICACIÓN TÉCNICA" tenga entidades de negocio claras.
